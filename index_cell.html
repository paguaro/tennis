<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Campi da tennis/padel più vicini (mobile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
  <style>
    html, body, #viewDiv {
      height:100%; width:100%; margin:0; padding:0;
      -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none;
    }

    /* Pulsante GPS originale */
    .iconbar {
      position:absolute; top:15px; right:10px; z-index:6;
      display:flex; gap:6px; align-items:center;
    }
    .iconbtn {
      background:transparent; border:none; cursor:pointer;
      padding:6px; min-width:32px; font-size:20px; line-height:1;
      border-radius:8px; touch-action:manipulation;
    }
    .iconbtn:active { transform:scale(.96); }

    /* Pannello campi vicini */
    #infoPanel {
      position:absolute; top:100px; right:10px; z-index:5;
      background:#fff; padding:6px 8px; border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:9px;
      overflow-y:auto; transition:all 0.3s ease; width:min(240px,35vw);
      max-height:50%; opacity:0.9; -webkit-overflow-scrolling:touch;
    }
    #infoPanel.collapsed { max-height:24px; opacity:0.4; padding:4px; }
    #infoContent { font-size:12px; }
    .toggle-chip {
      position:absolute; top:4px; left:4px; background:#f2f2f2;
      border:1px solid #ddd; cursor:pointer; border-radius:6px;
      padding:2px 6px; font-size:14px; user-select:none; z-index:10;
    }

    /* Messaggi */
    #toast, #error {
      position:absolute; left:50%; transform:translateX(-50%);
      color:#fff; padding:8px 12px; border-radius:6px; z-index:10;
      display:none; font-size:13px; box-shadow:0 3px 10px rgba(0,0,0,.2);
    }
    #toast { top:10px; background:#323232; }
    #error { top:50px; background:#d32f2f; }

    /* Loader */
    #loadingMessage {
      position:absolute; inset:0; display:grid; place-items:center;
      pointer-events:none; z-index:7;
    }
    #loadingBox {
      background:#fff; padding:12px 14px; border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.2); font-size:14px;
    }
    .hidden { display:none !important; }

    /* Legenda */
    .custom-legend {
      background:white; padding:8px; border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15); max-height:250px;
      overflow-y:auto; font-size:11px;
    }
    .legend-item {
      display:flex; align-items:center; margin-bottom:6px; padding:2px;
    }
    .legend-color {
      width:14px; height:14px; margin-right:6px; border-radius:50%;
    }
    .line-color {
      width:14px; height:3px; margin-right:6px; background-color:rgba(255,0,0,0.6);
    }
    .legend-label { flex:1; font-size:11px; }
    .legend-checkbox { margin-left:6px; transform:scale(0.8); }

    /* Risultati */
    .nearest-item {
      display:flex; align-items:flex-start; gap:6px; padding:3px 4px;
      border-radius:4px; cursor:pointer; transition:background-color 0.15s ease;
      touch-action:manipulation;
    }
    .nearest-item:hover { background:#f0f7ff; }
    .nearest-dot { flex:0 0 8px; width:8px; height:8px; border-radius:50%; margin-top:5px; }
    .nearest-name { margin:0; }
    .nearest-distance { font-size:11px; color:#555; }
  </style>
</head>
<body>
  <div id="viewDiv"></div>

  <!-- Pulsante GPS originale -->
  <div class="iconbar">
    <button id="btnGPS" class="iconbtn" title="Localizzami">GPS</button>
  </div>

  <!-- Pannello campi vicini -->
  <div id="infoPanel">
    <button id="toggleInfo" class="toggle-chip" title="Minimizza / Espandi">List</button>
    <div id="infoContent"></div>
  </div>

  <!-- Messaggi -->
  <div id="toast"></div>
  <div id="error"></div>
  <div id="loadingMessage"><div id="loadingBox">Caricamento campi da tennis…</div></div>

  <script src="https://js.arcgis.com/4.33/"></script>
  <script>
  require([
    "esri/Map","esri/views/MapView",
    "esri/layers/GraphicsLayer","esri/Graphic",
    "esri/geometry/Point","esri/geometry/Polyline","esri/geometry/Extent",
    "esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol",
    "esri/widgets/Search","esri/widgets/BasemapGallery","esri/widgets/Expand",
    "esri/widgets/Zoom","esri/widgets/Home",
    "esri/request","esri/core/reactiveUtils",
    "esri/geometry/support/webMercatorUtils"
  ], function(
    Map, MapView, GraphicsLayer, Graphic, Point, Polyline, Extent,
    SimpleMarkerSymbol, SimpleLineSymbol,
    Search, BasemapGallery, Expand, Zoom, Home,
    esriRequest, reactiveUtils, webMercatorUtils
  ){

    const map = new Map({ basemap: "osm" });
    const view = new MapView({
      container: "viewDiv", map, center: [12, 42], zoom: 5,
      popup: { enabled: true }, ui: { components: ["attribution"] }
    });

    const tennisLayer = new GraphicsLayer({ title:"Campi da tennis/padel", listMode:"show" });
    const linesLayer  = new GraphicsLayer({ title:"Linee di connessione", listMode:"show" });
    const locLayer    = new GraphicsLayer({ title:"Mia posizione", listMode:"show" });
    map.addMany([tennisLayer, linesLayer, locLayer]);

    view.ui.add(new Zoom({ view }), "top-left");
    
    // Usiamo il widget Home originale invece del componente web
    view.ui.add(new Home({ view }), "top-left");

    const legendContainer = document.createElement("div");
    legendContainer.className = "custom-legend";
    legendContainer.innerHTML = '<h4>Legenda</h4>';
    const legendExpand = new Expand({ view, content: legendContainer, expandIconClass:"esri-icon-layer-list", expandTooltip:"Legenda" });
    view.ui.add(legendExpand, "top-left");

    // Usiamo il widget Search originale invece del componente web
    const searchWidget = new Search({ view });
    view.ui.add(new Expand({ view, content: searchWidget, expandIcon:"search", expandTooltip:"Cerca luogo" }), "top-left");

    // Usiamo il widget BasemapGallery originale invece del componente web
const basemapGallery = new BasemapGallery({ 
  view: view,
  container: document.createElement("div")
});

const basemapExpand = new Expand({ 
  view: view, 
  content: basemapGallery, 
  expandIconClass: "esri-icon-basemap", 
  expandTooltip: "Cambia mappa",
  // Aggiungi auto-hide
  autoCollapse: true,
  expanded: false
});

view.ui.add(basemapExpand, "bottom-right");

    const btnGPS      = document.getElementById("btnGPS");
    const infoPanel   = document.getElementById("infoPanel");
    const infoContent = document.getElementById("infoContent");
    const toggleInfo  = document.getElementById("toggleInfo");
    const toast       = document.getElementById("toast");
    const errorBox    = document.getElementById("error");
    const loadingMsg  = document.getElementById("loadingMessage");

    toggleInfo.addEventListener("click", () => infoPanel.classList.toggle("collapsed"));

    const allPoints = [];
    let spatialGrid = {};
    let nearest = [];
    let showTennis = true;
    let showPadel  = true;

    const symLocation = new SimpleMarkerSymbol({
      color:[0,200,0,0.9], outline:{ color:[255,255,255], width:2 }, size:10
    });
    const symLine = new SimpleLineSymbol({
      color:[255,0,0,0.7], width:1.5, style:"short-dash"
    });

    function createCourtSymbol(attrs) {
      const sport = (attrs?.sport || "").toString().toLowerCase();
      const isPadel = sport === "padel";
      return new SimpleMarkerSymbol({
        color: isPadel ? [255,0,0,0.9] : [0,112,255,0.9],
        outline: { color: isPadel ? [255,200,200,1] : [80,220,255,1], width:1 },
        size: 4
      });
    }

    function isCourtVisibleByFilter(g) {
      const sport = (g.attributes?.sport || "").toString().toLowerCase();
      if (sport === "padel") return showPadel;
      if (sport === "tennis") return showTennis;
      return true;
    }

    function updateLegend() {
      while (legendContainer.children.length > 1) legendContainer.removeChild(legendContainer.lastChild);

      // Tennis
      const t = document.createElement("div"); t.className = "legend-item";
      t.innerHTML = `<div class="legend-color" style="background:rgba(0,112,255,0.9)"></div>
        <span class="legend-label">Campi da tennis</span>
        <input type="checkbox" class="legend-checkbox" ${showTennis?"checked":""}>`;
      t.querySelector("input").onchange = e => { showTennis = e.target.checked; tennisLayer.graphics.forEach(g => g.visible = isCourtVisibleByFilter(g)); };
      legendContainer.appendChild(t);

      // Padel
      const p = document.createElement("div"); p.className = "legend-item";
      p.innerHTML = `<div class="legend-color" style="background:rgba(255,0,0,0.9)"></div>
        <span class="legend-label">Campi da padel</span>
        <input type="checkbox" class="legend-checkbox" ${showPadel?"checked":""}>`;
      p.querySelector("input").onchange = e => { showPadel = e.target.checked; tennisLayer.graphics.forEach(g => g.visible = isCourtVisibleByFilter(g)); };
      legendContainer.appendChild(p);

      // Mia posizione
      const loc = document.createElement("div"); loc.className = "legend-item";
      loc.innerHTML = `<div class="legend-color" style="background:rgba(0,200,0,0.9)"></div>
        <span class="legend-label">Mia posizione</span>
        <input type="checkbox" class="legend-checkbox" ${locLayer.visible?"checked":""}>`;
      loc.querySelector("input").onchange = e => locLayer.visible = e.target.checked;
      legendContainer.appendChild(loc);

      // Linee di connessione
      const line = document.createElement("div"); line.className = "legend-item";
      line.innerHTML = `<div class="line-color"></div>
        <span class="legend-label">Linee di connessione</span>
        <input type="checkbox" class="legend-checkbox" ${linesLayer.visible?"checked":""}>`;
      line.querySelector("input").onchange = e => linesLayer.visible = e.target.checked;
      legendContainer.appendChild(line);
    }

    function showToast(msg, ms=2000) {
      toast.textContent = msg; toast.style.display = "block";
      clearTimeout(showToast.t); showToast.t = setTimeout(() => toast.style.display = "none", ms);
    }
    function showError(msg) {
      errorBox.textContent = msg; errorBox.style.display = "block";
      setTimeout(() => errorBox.style.display = "none", 5000);
    }

    function haversineMeters(a,b) {
      const R = 6371000;
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(b.latitude - a.latitude);
      const dLon = toRad(b.longitude - a.longitude);
      const lat1 = toRad(a.latitude);
      const lat2 = toRad(b.latitude);
      const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return Math.round(2*R*Math.asin(Math.sqrt(s)));
    }

    // === POPUP CON AZIONI WAZE, GOOGLE, COPIA ===
    function createPopupTemplate(attrs) {
      const sport = (attrs?.sport || "").toString().toLowerCase();
      const title = attrs.name || (sport === "padel" ? "Campo da padel" : "Campo da tennis");
      return {
        title: title,
        content: ({ graphic }) => {
          const a = graphic.attributes;
          let table = "<table style='width:100%;font-size:11px'>";
          Object.keys(a).sort().forEach(k => {
            if (a[k]) table += `<tr><th style='text-align:left;padding:2px 4px'>${k.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase())}</th><td>${a[k]}</td></tr>`;
          });
          table += `</table><div style='margin-top:8px'><strong>Coordinate:</strong> ${graphic.geometry.latitude.toFixed(6)}, ${graphic.geometry.longitude.toFixed(6)}</div>`;
          return table;
        },
        actions: [
          { title:"Waze", id:"open-waze", image:"https://paguaro.github.io/Points_icnf/waze-icon.png" },
          { title:"Google Maps", id:"open-google-maps", image:"https://paguaro.github.io/Points_icnf/google-maps-icon.png" },
          { title:"Copia coordinate", id:"copy-coords", image:"https://paguaro.github.io/Points_icnf/coordinates-icon.png" },
          { title:"Copia GeoJSON", id:"copy-geojson", image:"https://paguaro.github.io/Points_icnf/geojson-icon.png" }
        ]
      };
    }

    // === CARICAMENTO GEOJSON ===
    esriRequest("tennis_it.geojson", { responseType:"json" })
      .then(r => {
        const features = r.data.features || [];
        features.forEach(f => {
          const c = f.geometry?.coordinates;
          if (!c || c.length < 2) return;
          const pt = new Point({ longitude: +c[0], latitude: +c[1] });
          const g = new Graphic({
            geometry: pt,
            attributes: f.properties || {},
            symbol: createCourtSymbol(f.properties),
            popupTemplate: createPopupTemplate(f.properties)
          });
          allPoints.push(g);
          tennisLayer.add(g);
        });

        if (allPoints.length) {
          view.goTo(allPoints.map(g => g.geometry)).catch(() => {});
          buildSpatialGrid(allPoints);
          updateLegend();
        }
      })
      .catch(e => { console.error(e); showError("Errore caricamento dati"); })
      .finally(() => loadingMsg.classList.add("hidden"));

    function buildSpatialGrid(points) {
      spatialGrid = {};
      points.forEach(p => {
        const gx = Math.floor(p.geometry.longitude / 0.5);
        const gy = Math.floor(p.geometry.latitude / 0.5);
        const key = `${gx},${gy}`;
        (spatialGrid[key] ||= []).push(p);
      });
    }

    function findNearest(pt) {
      if (!allPoints.length || !pt) return;
      linesLayer.removeAll();
      nearest = [];

      const visible = allPoints.filter(isCourtVisibleByFilter);
      if (!visible.length) { renderInfo(); return; }

      const gx = Math.floor(pt.longitude / 0.5);
      const gy = Math.floor(pt.latitude / 0.5);
      let candidates = [];
      for (let dx=-2; dx<=2; dx++) for (let dy=-2; dy<=2; dy++) {
        const cell = spatialGrid[`${gx+dx},${gy+dy}`];
        if (cell) candidates.push(...cell);
      }
      if (candidates.length < 5) candidates = visible;

      nearest = candidates
        .map(g => ({ feature: g, distance: haversineMeters(pt, g.geometry) }))
        .filter(o => o.distance <= 5000)
        .sort((a,b) => a.distance - b.distance)
        .slice(0,5);

      nearest.forEach(o => {
        const line = new Polyline({ paths: [[pt.longitude, pt.latitude], [o.feature.geometry.longitude, o.feature.geometry.latitude]], spatialReference: { wkid: 4326 } });
        linesLayer.add(new Graphic({ geometry: line, symbol: symLine }));
      });

      renderInfo();
    }

    function renderInfo() {
      let html = `<h4 style="margin:4px 0 6px;text-align:center;">Campi più vicini <small>(entro 5 km)</small>:</h4>`;
      if (!nearest.length) {
        html += "<p style='margin:0'>Nessun campo trovato entro 5 km.</p>";
      } else {
        html += "<div class='nearest-list'>";
        nearest.forEach((o,i) => {
          const a = o.feature.attributes;
          const name = a.name || `Campo #${a.OBJECTID || i+1}`;
          const sport = (a.sport || "").toString().toLowerCase();
          const color = sport==="padel" ? "#ff0000" : sport==="tennis" ? "#0070ff" : "#999";
          html += `
            <div class="nearest-item" data-idx="${i}">
              <span class="nearest-dot" style="background:${color}"></span>
              <div class="nearest-text">
                <div class="nearest-name"><strong>${name}</strong> ${sport?`(${sport})`:""}</div>
                <div class="nearest-distance">${o.distance.toLocaleString("it-IT")} m</div>
              </div>
            </div>`;
        });
        html += "</div>";
      }
      infoContent.innerHTML = html;

      infoContent.querySelectorAll(".nearest-item").forEach(el => {
        el.onclick = () => {
          const g = nearest[el.dataset.idx].feature;
          view.goTo({ target: g.geometry, zoom: 17 });
          view.popup.open({ features: [g], location: g.geometry });
        };
      });
    }

    // === AZIONI POPUP (Waze, Google, Copia) ===
    reactiveUtils.on(() => view.popup, "trigger-action", event => {
      if (!view.popup.selectedFeature) return;
      const g = view.popup.selectedFeature.geometry;
      const lat = g.latitude.toFixed(6);
      const lon = g.longitude.toFixed(6);
      const attrs = view.popup.selectedFeature.attributes;

      switch (event.action.id) {
        case "open-waze":
          window.open(`https://waze.com/ul?ll=${lat},${lon}&navigate=yes`, "_blank");
          break;
        case "open-google-maps":
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, "_blank");
          break;
        case "copy-coords":
          navigator.clipboard?.writeText?.(`${lat}, ${lon}`).then(() => showToast("Coordinate copiate!"));
          break;
        case "copy-geojson":
          const geojson = JSON.stringify({
            type:"Feature",
            geometry:{ type:"Point", coordinates:[parseFloat(lon), parseFloat(lat)] },
            properties: attrs
          }, null, 2);
          navigator.clipboard?.writeText?.(geojson).then(() => showToast("GeoJSON copiato!"));
          break;
      }
    });

    // Aggiornamenti automatici
    view.when(() => { if (view.center) findNearest(view.center); });
    reactiveUtils.watch(() => view.stationary, s => { if (s && view.center) findNearest(view.center.clone()); });
    view.on("click", e => { if (e.mapPoint) findNearest(e.mapPoint); });

    // GPS con pin verde originale
    btnGPS.onclick = () => {
      if (!navigator.geolocation) return showError("Geolocalizzazione non supportata");
      navigator.geolocation.getCurrentPosition(
        pos => {
          const pt = new Point({ longitude: pos.coords.longitude, latitude: pos.coords.latitude });
          view.goTo({ target: pt, zoom: 14 });
          locLayer.removeAll();
          locLayer.add(new Graphic({ geometry: pt, symbol: symLocation }));
          showToast("Posizione rilevata");
          findNearest(pt);
        },
        () => showError("Impossibile ottenere la posizione"),
        { enableHighAccuracy: true, maximumAge: 30000, timeout: 10000 }
      );
    };

  });
  </script>
</body>
</html>